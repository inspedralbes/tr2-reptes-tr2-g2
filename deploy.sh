#!/bin/bash

# --- CONFIGURACIÃ“N ---
# Directorio donde estÃ¡ tu proyecto en el servidor
# Si se ejecuta desde el mismo directorio, podemos usar $(pwd)
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Colores para logs bonitos
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${YELLOW}ğŸš€ Iniciando despliegue de Iter Monorepo...${NC}"

# 1. Ir al directorio
cd "$PROJECT_DIR" || { echo -e "${RED}âŒ Error: No encuentro el directorio $PROJECT_DIR${NC}"; exit 1; }

# 2. Bajar Ãºltimos cambios de Git (Opcional si se usa --no-reset)
if [[ "$1" == "--no-reset" ]]; then
  echo -e "${YELLOW}â© Saltando descarga de cambios (usando archivos locales)...${NC}"
else
  echo -e "${YELLOW}ğŸ“¥ Descargando cambios desde GitHub (main)...${NC}"
  git fetch origin main
  git reset --hard origin/main
fi

# 3. Permisos (por si acaso han cambiado scripts)
chmod +x deploy.sh

# 4. Asegurar archivos .env (Necesarios para Docker Compose)
echo -e "${YELLOW}ğŸ”‘ Verificando archivos de entorno (.env)...${NC}"

if [ ! -f ".env" ]; then
  echo -e "${YELLOW}âš ï¸ .env root no encontrado. Creando uno bÃ¡sico...${NC}"
  echo "# Autogenerated by deploy.sh" > .env
  echo "POSTGRES_USER=postgres" >> .env
  echo "POSTGRES_PASSWORD=root" >> .env
  echo "POSTGRES_DB=iter_db" >> .env
  # Apuntamos a host.docker.internal para acceder a la BD del host
  echo "DATABASE_URL=postgresql://postgres:root@host.docker.internal:5432/iter_db?schema=public" >> .env
fi

if [ ! -f "apps/api/.env" ]; then
  echo -e "${YELLOW}âš ï¸ apps/api/.env no encontrado. Creando uno bÃ¡sico...${NC}"
  echo "# Autogenerated by deploy.sh" > apps/api/.env
  echo "PORT=3000" >> apps/api/.env
fi

if [ ! -f "apps/web/.env" ]; then
  echo -e "${YELLOW}âš ï¸ apps/web/.env no encontrado. Creando uno bÃ¡sico...${NC}"
  echo "# Autogenerated by deploy.sh" > apps/web/.env
  echo "NEXT_PUBLIC_API_URL=https://api-iter.kore29.com" >> apps/web/.env
fi

# 5. ReconstrucciÃ³n inteligente (Docker Prod)
echo -e "${YELLOW}ğŸ³ Construyendo imÃ¡genes de ProducciÃ³n (Multi-stage)...${NC}"
# Usamos --build para forzar que coja los cambios de cÃ³digo
docker compose -f docker-compose.prod.yml up --build -d --remove-orphans

# 5. VerificaciÃ³n de salud
if [ $? -eq 0 ]; then
  echo -e "${GREEN}âœ… Â¡Despliegue completado con Ã©xito!${NC}"
  echo -e "${GREEN}ğŸ‘‰ Web: https://iter.kore29.com${NC}"
  echo -e "${GREEN}ğŸ‘‰ API: https://api-iter.kore29.com${NC}"
  
  # 6. Limpieza de basura espacial (Importante en VPS)
  echo -e "${YELLOW}ğŸ§¹ Limpiando imÃ¡genes antiguas para ahorrar espacio...${NC}"
  docker image prune -f
else
  echo -e "${RED}âŒ OcurriÃ³ un error al levantar los contenedores.${NC}"
  exit 1
fi