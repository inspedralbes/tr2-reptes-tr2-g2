generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Basados en el diagrama) ---
enum Modalitat {
  A
  B
  C
}

enum EstatPeticio {
  PENDENT
  ACCEPTADA
  REBUTJADA
  MODIFICADA
}

enum EstatAssignacio {
  ACTIVA
  CANCEL_LADA
  FINALITZADA
}

enum EstatAssistencia {
  PRESENT
  ABSENT
  RETARD
  JUSTIFICAT
}

// --- TABLAS MAESTRAS ---

model Sector {
  id          Int      @id @default(autoincrement())
  nom         String   @db.VarChar(255)
  descripcio  String?  @db.Text
  
  tallers     Taller[] // Relación inversa

  @@map("sectors")
}

model Rol {
  id      Int      @id @default(autoincrement())
  nom_rol String   @unique @db.VarChar(50) // 'ADMIN', 'COORDINADOR', 'PROFESSOR'
  
  usuaris Usuari[]

  @@map("rols")
}

model Centre {
  id               Int     @id @default(autoincrement())
  codi_centre      String  @unique @db.VarChar(50)
  nom              String  @db.VarChar(255)
  adreca           String? @db.VarChar(255)
  telefon_contacte String? @db.VarChar(20)
  email_contacte   String  @unique @db.VarChar(255)
  
  // Relaciones
  usuaris          Usuari[]
  peticions        Peticio[]
  assignacions     Assignacio[]
  alumnes          Alumne[] // "centre_procedencia"

  @@map("centres")
}

// --- USUARIOS Y TALLERES ---

model Usuari {
  id            Int      @id @default(autoincrement())
  nom_complet   String   @db.VarChar(255)
  email         String   @unique @db.VarChar(255)
  password_hash String   @db.VarChar(255)
  
  // Relaciones
  id_rol        Int
  rol           Rol      @relation(fields: [id_rol], references: [id])
  
  id_centre     Int?     // Puede ser null si es Admin global
  centre        Centre?  @relation(fields: [id_centre], references: [id])
  
  logs          LogAuditoria[]
  assignacions_profesor AssignacioProfessor[]

  @@map("usuaris")
}

model Taller {
  id               Int       @id @default(autoincrement())
  titol            String    @db.VarChar(255)
  descripcio_curta String?   @db.VarChar(255)
  durada_h         Int
  places_maximes   Int
  modalitat        Modalitat
  
  id_sector        Int
  sector           Sector    @relation(fields: [id_sector], references: [id])
  
  peticions        Peticio[]
  assignacions     Assignacio[]

  @@map("tallers")
}

// --- EL FLUJO DE NEGOCIO (CORE) ---

model Peticio {
  id            Int          @id @default(autoincrement())
  data_peticio  DateTime     @default(now())
  estat         EstatPeticio @default(PENDENT)
  alumnes_aprox Int
  comentaris    String?      @db.Text

  id_centre     Int
  centre        Centre       @relation(fields: [id_centre], references: [id])
  
  id_taller     Int
  taller        Taller       @relation(fields: [id_taller], references: [id])
  
  assignacions  Assignacio[]

  @@map("peticions")
}

model Assignacio {
  id            Int             @id @default(autoincrement())
  data_inici    DateTime        @db.Date
  data_fi       DateTime        @db.Date
  estat         EstatAssignacio @default(ACTIVA)

  id_peticio    Int
  peticio       Peticio         @relation(fields: [id_peticio], references: [id])

  id_centre     Int
  centre        Centre          @relation(fields: [id_centre], references: [id])

  id_taller     Int
  taller        Taller          @relation(fields: [id_taller], references: [id])

  inscripcions  Inscripcio[]
  professors    AssignacioProfessor[]
  checklists    ChecklistAssignacio[]

  @@map("assignacions")
}

// Tabla intermedia para asignar profesores a una asignación (N:M)
model AssignacioProfessor {
  id_assignacio Int
  assignacio    Assignacio @relation(fields: [id_assignacio], references: [id])

  id_usuari     Int
  usuari        Usuari     @relation(fields: [id_usuari], references: [id])

  es_principal  Boolean    @default(false)

  @@id([id_assignacio, id_usuari]) // Clave compuesta
  @@map("assignacio_professors")
}

// --- ALUMNOS E INSCRIPCIONES ---

model Alumne {
  id                    Int      @id @default(autoincrement())
  idalu                 String   @unique @db.VarChar(50) // VITAL para el Consorci
  nom                   String   @db.VarChar(100)
  cognoms               String   @db.VarChar(100)
  curs                  String   @db.VarChar(20) 
  
  id_centre_procedencia Int
  centre_procedencia    Centre   @relation(fields: [id_centre_procedencia], references: [id])

  inscripcions          Inscripcio[]

  @@map("alumnes")
}

model Inscripcio {
  id            Int           @id @default(autoincrement())
  
  id_assignacio Int
  assignacio    Assignacio    @relation(fields: [id_assignacio], references: [id])

  id_alumne     Int
  alumne        Alumne        @relation(fields: [id_alumne], references: [id])
  
  assistencies  Assistencia[]
  // avaluacions   AvaluacioCompetencial[]

  @@map("inscripcions")
}

model Assistencia {
  id            Int              @id @default(autoincrement())
  numero_sessio Int
  data_sessio   DateTime         @db.Date
  estat         EstatAssistencia
  observacions  String?          @db.VarChar(255)

  id_inscripcio Int
  inscripcio    Inscripcio       @relation(fields: [id_inscripcio], references: [id])

  @@map("assistencia")
}

// --- AUDITORÍA Y EXTRAS ---

model LogAuditoria {
  id              Int      @id @default(autoincrement())
  accio           String
  taula_afectada  String
  data_hora       DateTime @default(now())
  details         Json?    // Para guardar el "antes" y "después"

  id_usuari       Int
  usuari          Usuari   @relation(fields: [id_usuari], references: [id])

  @@map("logs_auditoria")
}

model ChecklistAssignacio {
  id              Int       @id @default(autoincrement())
  pas_nom         String
  completat       Boolean   @default(false)
  data_completat  DateTime?
  
  id_assignacio   Int
  assignacio      Assignacio @relation(fields: [id_assignacio], references: [id])

  @@map("checklist_assignacio")
}

// He omitido de momento "Competencies" y "Questionaris" para no abrumar,
// pero se añaden igual de fácil aquí debajo cuando queráis.