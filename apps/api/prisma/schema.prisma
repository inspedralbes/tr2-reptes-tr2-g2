// apps/api/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Basados en tu diagrama) ---
enum Modalitat {
  A
  B
  C
}

enum EstatPeticio {
  PENDENT
  ACCEPTADA
  REBUTJADA
  MODIFICADA
}

enum Rol {
  ADMIN
  COORDINADOR
  PROFESSOR
}

// --- MODELOS PRINCIPALES ---

model Sector {
  id          Int      @id @default(autoincrement())
  nom         String   @db.VarChar(255)
  descripcio  String?  @db.Text
  tallers     Taller[] // Relación 1:N

  @@map("sectors")
}

model Centre {
  id              Int       @id @default(autoincrement())
  codi_centre     String    @unique @db.VarChar(50)
  nom             String    @db.VarChar(255)
  adreca          String?   @db.VarChar(255)
  telefon         String?   @db.VarChar(20)
  email           String    @unique @db.VarChar(255)
  
  usuaris         Usuari[]
  peticions       Peticio[]
  assignacions    Assignacio[]

  @@map("centres")
}

model Taller {
  id              Int       @id @default(autoincrement())
  titol           String    @db.VarChar(255)
  descripcio      String?   @db.VarChar(255)
  durada_h        Int
  places_maximes  Int
  modalitat       Modalitat 
  
  sector_id       Int
  sector          Sector    @relation(fields: [sector_id], references: [id])
  
  peticions       Peticio[]
  assignacions    Assignacio[]

  @@map("tallers")
}

model Usuari {
  id            Int      @id @default(autoincrement())
  nom_complet   String   @db.VarChar(255)
  email         String   @unique @db.VarChar(255)
  password_hash String   @db.VarChar(255)
  rol           Rol      @default(PROFESSOR)
  
  centre_id     Int?     // Admin no tiene centro, Coord/Prof sí
  centre        Centre?  @relation(fields: [centre_id], references: [id])
  
  logs          LogAuditoria[]

  @@map("usuaris")
}

// --- MODELOS DE GESTIÓN (El flujo de negocio) ---

model Peticio {
  id            Int          @id @default(autoincrement())
  data_peticio  DateTime     @default(now())
  estat         EstatPeticio @default(PENDENT)
  alumnes_aprox Int
  comentaris    String?      @db.Text

  centre_id     Int
  centre        Centre       @relation(fields: [centre_id], references: [id])
  
  taller_id     Int
  taller        Taller       @relation(fields: [taller_id], references: [id])
  
  assignacions  Assignacio[] // Si se aprueba, genera una asignación

  @@map("peticions")
}

model Assignacio {
  id            Int      @id @default(autoincrement())
  data_inici    DateTime @db.Date
  data_fi       DateTime @db.Date
  estat         String   @default("ACTIVA") // O usa enum si prefieres

  peticio_id    Int
  peticio       Peticio  @relation(fields: [peticio_id], references: [id])

  taller_id     Int
  taller        Taller   @relation(fields: [taller_id], references: [id])
  
  centre_id     Int
  centre        Centre   @relation(fields: [centre_id], references: [id])

  inscripcions  Inscripcio[]

  @@map("assignacions")
}

model Alumne {
  id            Int      @id @default(autoincrement())
  idalu         String   @unique @db.VarChar(50) // Identificador del consorci
  nom           String   @db.VarChar(100)
  cognoms       String   @db.VarChar(100)
  curs          String   @db.VarChar(20) // ej: "3r ESO"

  inscripcions  Inscripcio[]

  @@map("alumnes")
}

model Inscripcio {
  id            Int      @id @default(autoincrement())
  
  assignacio_id Int
  assignacio    Assignacio @relation(fields: [assignacio_id], references: [id])

  alumne_id     Int
  alumne        Alumne     @relation(fields: [alumne_id], references: [id])
  
  assistencies  Assistencia[]

  @@map("inscripcions")
}

model Assistencia {
  id            Int      @id @default(autoincrement())
  data_sessio   DateTime @db.Date
  estat         String   // "PRESENT", "ABSENT", "RETARD"
  observacions  String?

  inscripcio_id Int
  inscripcio    Inscripcio @relation(fields: [inscripcio_id], references: [id])

  @@map("assistencia")
}

model LogAuditoria {
  id            Int      @id @default(autoincrement())
  accio         String
  taula_afectada String
  data_hora     DateTime @default(now())

  usuari_id     Int
  usuari        Usuari   @relation(fields: [usuari_id], references: [id])

  @@map("logs_auditoria")
}